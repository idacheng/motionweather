<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å‘¼å¸å¤©æ°” - æˆ‘ä¸ä½ åŒåœ¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            overflow: hidden;
            touch-action: manipulation;
        }

        #app {
            width: 100vw;
            height: 100vh;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 40px 20px 60px;
            transition: background 2.5s ease;
        }

        /* å¤©æ°”èƒŒæ™¯æ¸å˜ */
        .weather-bg-clear { background: linear-gradient(180deg, #87CEEB 0%, #E0F6FF 100%); }
        .weather-bg-lightCloud { background: linear-gradient(180deg, #B0C4DE 0%, #F0F8FF 100%); }
        .weather-bg-overcast { background: linear-gradient(180deg, #708090 0%, #2F4F4F 100%); }
        .weather-bg-fog { background: linear-gradient(180deg, #D3D3D3 0%, #A9A9A9 100%); }
        .weather-bg-rain { background: linear-gradient(180deg, #4682B4 0%, #2C3E50 100%); }
        .weather-bg-heavyRain { background: linear-gradient(180deg, #1C1C1C 0%, #000080 100%); }
        .weather-bg-wind { background: linear-gradient(180deg, #5F9EA0 0%, #8B8680 100%); }
        .weather-bg-still { background: linear-gradient(180deg, #2C2C2C 0%, #1A1A1A 100%); }
        .weather-bg-dusk { background: linear-gradient(180deg, #FF6B6B 0%, #4A0E4E 100%); }
        .weather-bg-night { background: linear-gradient(180deg, #0B0B2B 0%, #000000 100%); }
        .weather-bg-thunder { background: linear-gradient(180deg, #191970 0%, #000000 100%); }
        .weather-bg-snow { background: linear-gradient(180deg, #E8E8E8 0%, #B0C4DE 100%); }

        /* å¤©æ°”æ ‡ç­¾ */
        .weather-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 13px;
            font-weight: 500;
            padding: 8px 16px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .weather-badge svg {
            width: 12px;
            height: 12px;
            fill: currentColor;
        }

        /* å‘¼å¸å°çƒå®¹å™¨ */
        .orb-container {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
        }

        /* å¤–å‘å…‰ */
        .orb-glow {
            position: absolute;
            width: 220px;
            height: 220px;
            border-radius: 50%;
            filter: blur(30px);
            opacity: 0.3;
            animation: breathe-glow 4s ease-in-out infinite;
        }

        @keyframes breathe-glow {
            0%, 100% { transform: scale(0.9); opacity: 0.2; }
            50% { transform: scale(1.1); opacity: 0.4; }
        }

        /* ä¸»çƒä½“ */
        .orb {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            position: relative;
            animation: breathe 4s ease-in-out infinite;
            box-shadow: inset -20px -20px 60px rgba(0,0,0,0.1),
                        inset 20px 20px 60px rgba(255,255,255,0.4),
                        0 10px 40px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
        }

        @keyframes breathe {
            0%, 100% { transform: scale(0.85); }
            50% { transform: scale(1.05); }
        }

        /* é«˜å…‰æ•ˆæœ */
        .orb::before {
            content: '';
            position: absolute;
            top: 20%;
            left: 20%;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.4);
            filter: blur(20px);
        }

        /* çƒä½“é¢œè‰² */
        .orb-clear { background: radial-gradient(circle at 30% 30%, #FFF9E6, #FFD700 50%, #FFA500); }
        .orb-lightCloud { background: radial-gradient(circle at 30% 30%, #FFFFFF, #C0C0C0 50%, #A0A0A0); }
        .orb-overcast { background: radial-gradient(circle at 30% 30%, #E0E0E0, #808080 50%, #606060); }
        .orb-fog { background: radial-gradient(circle at 30% 30%, #FFFFFF, #E0E0E0 50%, #C0C0C0); }
        .orb-rain { background: radial-gradient(circle at 30% 30%, #B0D4F1, #4A90D9 50%, #2E5C8A); }
        .orb-heavyRain { background: radial-gradient(circle at 30% 30%, #4A5568, #2C3E50 50%, #1A252F); }
        .orb-wind { background: radial-gradient(circle at 30% 30%, #E0E0E0, #7F8C8D 50%, #5D6D7E); }
        .orb-still { background: radial-gradient(circle at 30% 30%, #4A5568, #34495E 50%, #2C3E50); }
        .orb-dusk { background: radial-gradient(circle at 30% 30%, #FFB6B6, #E74C3C 50%, #C0392B); }
        .orb-night { background: radial-gradient(circle at 30% 30%, #D8BFD8, #8E44AD 50%, #6C3483); }
        .orb-thunder { background: radial-gradient(circle at 30% 30%, #D8BFD8, #9B59B6 50%, #7D3C98); }
        .orb-snow { background: radial-gradient(circle at 30% 30%, #FFFFFF, #ECF0F1 50%, #BDC3C7); }

        /* å¤©æ°”å›¾æ ‡ */
        .weather-icon {
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
            animation: icon-breathe 4s ease-in-out infinite;
        }

        @keyframes icon-breathe {
            0%, 100% { transform: scale(0.9); opacity: 0.8; }
            50% { transform: scale(1); opacity: 1; }
        }

        /* æ–‡å­—åŒºåŸŸ */
        .text-area {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .main-text {
            font-size: 20px;
            font-weight: 300;
            letter-spacing: 3px;
            opacity: 0.9;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .mood-text {
            font-size: 14px;
            font-weight: 300;
            opacity: 0.6;
            margin-top: 12px;
            max-width: 300px;
            line-height: 1.5;
        }

        /* è¾“å…¥æŒ‰é’® */
        .input-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
            font-size: 16px;
            font-weight: 500;
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .input-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }

        .input-btn:active {
            transform: translateY(0);
        }

        /* å¼¹çª—é®ç½© */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: flex-end;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.active {
            display: flex;
            opacity: 1;
        }

        /* å¼¹çª—å†…å®¹ */
        .modal-content {
            width: 100%;
            max-width: 500px;
            background: linear-gradient(180deg, #1A1A2E 0%, #16213E 100%);
            border-radius: 24px 24px 0 0;
            padding: 24px 20px 40px;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        /* å¼¹çª—å¤´éƒ¨ */
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-title {
            color: white;
            font-size: 18px;
            font-weight: 500;
        }

        .close-btn {
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px 8px;
        }

        /* è¾“å…¥æ¡† */
        .mood-input {
            width: 100%;
            min-height: 120px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            color: white;
            font-size: 16px;
            line-height: 1.6;
            resize: none;
            font-family: inherit;
            margin-bottom: 16px;
        }

        .mood-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .mood-input:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.3);
        }

        /* å¿«é€Ÿæ ‡ç­¾ */
        .quick-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 24px;
        }

        .tag {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 20px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tag:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .tag.active {
            background: rgba(255, 255, 255, 0.3);
        }

        /* æäº¤æŒ‰é’® */
        .submit-btn {
            width: 100%;
            padding: 16px;
            background: rgba(59, 130, 246, 0.6);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .submit-btn:hover:not(:disabled) {
            background: rgba(59, 130, 246, 0.8);
            transform: translateY(-1px);
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* åŠ è½½åŠ¨ç”» */
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* å¤©æ°”ç‰¹æ•ˆ Canvas */
        #weather-effects {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        /* æç¤ºæ¶ˆæ¯ */
        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            font-size: 14px;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
            z-index: 2000;
            backdrop-filter: blur(10px);
        }

        .toast.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        /* API çŠ¶æ€æç¤º */
        .api-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            color: white;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            z-index: 100;
        }
    </style>
</head>
<body>
    <div id="app" class="weather-bg-clear">
        <div class="api-status" id="api-status">ğŸ”® Gemini AI</div>
        <canvas id="weather-effects"></canvas>
        
        <!-- å¤©æ°”æ ‡ç­¾ -->
        <div class="weather-badge">
            <svg viewBox="0 0 24 24">
                <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
            </svg>
            <span id="weather-text">å†…å¿ƒå¤©æ°”ï¼šæ™´æœ—</span>
        </div>

        <!-- å‘¼å¸å°çƒ -->
        <div class="orb-container">
            <div class="orb-glow" id="orb-glow"></div>
            <div class="orb orb-clear" id="orb">
                <span class="weather-icon" id="weather-icon">â˜€ï¸</span>
            </div>
        </div>

        <!-- æ–‡å­—åŒºåŸŸ -->
        <div class="text-area">
            <div class="main-text">æˆ‘ä¸ä½ åŒåœ¨</div>
            <div class="mood-text" id="mood-text"></div>
        </div>

        <!-- è¾“å…¥æŒ‰é’® -->
        <button class="input-btn" onclick="openModal()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
            è®°å½•æ­¤åˆ»
        </button>
    </div>

    <!-- è¾“å…¥å¼¹çª— -->
    <div class="modal-overlay" id="modal" onclick="closeModalOnOverlay(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span class="modal-title">è®°å½•å¿ƒæƒ…</span>
                <button class="close-btn" onclick="closeModal()">å–æ¶ˆ</button>
            </div>
            
            <div style="color: rgba(255,255,255,0.8); font-size: 16px; margin-bottom: 16px;">
                æ­¤åˆ»çš„ä½ ï¼Œæ˜¯ä»€ä¹ˆçŠ¶æ€ï¼Ÿ
            </div>
            
            <textarea 
                class="mood-input" 
                id="mood-input" 
                placeholder="æ¯”å¦‚ï¼šä»Šå¤©å·¥ä½œå‹åŠ›å¾ˆå¤§ï¼Œæœ‰ç‚¹å–˜ä¸è¿‡æ°”..."
                oninput="checkInput()"
            ></textarea>
            
            <div class="quick-tags">
                <button class="tag" onclick="selectTag('ç„¦è™‘')">ç„¦è™‘</button>
                <button class="tag" onclick="selectTag('å¹³é™')">å¹³é™</button>
                <button class="tag" onclick="selectTag('å­¤ç‹¬')">å­¤ç‹¬</button>
                <button class="tag" onclick="selectTag('å¼€å¿ƒ')">å¼€å¿ƒ</button>
                <button class="tag" onclick="selectTag('è¿·èŒ«')">è¿·èŒ«</button>
                <button class="tag" onclick="selectTag('æ€å¿µ')">æ€å¿µ</button>
            </div>
            
            <button class="submit-btn" id="submit-btn" onclick="analyzeMood()" disabled>
                <span>ç”Ÿæˆå¤©æ°”</span>
            </button>
        </div>
    </div>

    <!-- æç¤ºæ¶ˆæ¯ -->
    <div class="toast" id="toast"></div>

    <script>
        // Gemini API é…ç½®
        const GEMINI_API_KEY = 'AIzaSyCzX60tSYePqrZ4nA0a9uERpIoggMXJbiM';
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent';
        
        // å¤©æ°”é…ç½®
        const weatherConfig = {
            clear: { name: 'æ™´æœ—', icon: 'â˜€ï¸', bg: 'weather-bg-clear', orb: 'orb-clear', keywords: ['æ™´æœ—', 'æ™´å¤©', 'å¼€å¿ƒ', 'å¿«ä¹', 'å¹¸ç¦', 'æ»¡è¶³', 'æ„‰æ‚¦', 'positive'] },
            lightCloud: { name: 'å¤šäº‘', icon: 'â›…', bg: 'weather-bg-lightCloud', orb: 'orb-lightCloud', keywords: ['å¤šäº‘', 'è½»å¾®å¿§è™‘', 'ä¸ç¡®å®š', 'çŠ¹è±«'] },
            overcast: { name: 'é˜´å¤©', icon: 'â˜ï¸', bg: 'weather-bg-overcast', orb: 'orb-overcast', keywords: ['é˜´å¤©', 'éƒé—·', 'ä½è½', 'æ— ç²¾æ‰“é‡‡', 'å‹æŠ‘', 'æ²®ä¸§'] },
            fog: { name: 'é›¾', icon: 'ğŸŒ«ï¸', bg: 'weather-bg-fog', orb: 'orb-fog', keywords: ['é›¾', 'è¿·èŒ«', 'å›°æƒ‘', 'çœ‹ä¸æ¸…', 'è¿·å¤±'] },
            rain: { name: 'å°é›¨', icon: 'ğŸŒ§ï¸', bg: 'weather-bg-rain', orb: 'orb-rain', keywords: ['å°é›¨', 'é›¨', 'ä¼¤æ„Ÿ', 'æ€å¿µ', 'æ¸©æŸ”', 'æ€€æ—§', 'æƒ³'] },
            heavyRain: { name: 'å¤§é›¨', icon: 'â›ˆï¸', bg: 'weather-bg-heavyRain', orb: 'orb-heavyRain', keywords: ['å¤§é›¨', 'æš´é›¨', 'æ‚²ä¼¤', 'ç—›è‹¦', 'å¤±è½', 'éš¾è¿‡', 'å“­'] },
            wind: { name: 'é£', icon: 'ğŸ’¨', bg: 'weather-bg-wind', orb: 'orb-wind', keywords: ['é£', 'ç„¦è™‘', 'çƒ¦èº', 'ç´§å¼ ', 'å‹åŠ›', 'æ€¥', 'èº'] },
            still: { name: 'æ— é£', icon: 'ğŸŒ‘', bg: 'weather-bg-still', orb: 'orb-still', keywords: ['æ— é£', 'é™æ­¢', 'ç©ºè™š', 'éº»æœ¨', 'ç–²æƒ«', 'ç´¯', 'éº»'] },
            dusk: { name: 'é»„æ˜', icon: 'ğŸŒ…', bg: 'weather-bg-dusk', orb: 'orb-dusk', keywords: ['é»„æ˜', 'å‚æ™š', 'æ€€æ—§', 'æ„Ÿæ…¨', 'æ—¶å…‰', 'æ›¾ç»', 'è¿‡å»'] },
            night: { name: 'æ·±å¤œ', icon: 'ğŸŒ™', bg: 'weather-bg-night', orb: 'orb-night', keywords: ['æ·±å¤œ', 'å¤œ', 'é»‘å¤œ', 'å­¤ç‹¬', 'å¯‚å¯', 'æ²‰æ€', 'ä¸€ä¸ªäºº'] },
            thunder: { name: 'é›·é›¨', icon: 'âš¡', bg: 'weather-bg-thunder', orb: 'orb-thunder', keywords: ['é›·é›¨', 'é›·', 'æ„¤æ€’', 'çˆ†å‘', 'ç”Ÿæ°”', 'æ€’', 'çƒ¦æ­»äº†'] },
            snow: { name: 'é›ª', icon: 'â„ï¸', bg: 'weather-bg-snow', orb: 'orb-snow', keywords: ['é›ª', 'ä¸‹é›ª', 'å®é™', 'çº¯å‡€', 'å¹³å’Œ', 'å®‰é™', 'ç¦…'] }
        };

        let currentWeather = 'clear';
        let weatherEffectId = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            initWeatherEffects();
        });

        // æ‰“å¼€å¼¹çª—
        function openModal() {
            document.getElementById('modal').classList.add('active');
            document.getElementById('mood-input').focus();
        }

        // å…³é—­å¼¹çª—
        function closeModal() {
            document.getElementById('modal').classList.remove('active');
            setTimeout(() => {
                document.getElementById('mood-input').value = '';
                checkInput();
            }, 300);
        }

        // ç‚¹å‡»é®ç½©å…³é—­
        function closeModalOnOverlay(event) {
            if (event.target === event.currentTarget) {
                closeModal();
            }
        }

        // é€‰æ‹©æ ‡ç­¾
        function selectTag(tag) {
            document.getElementById('mood-input').value = tag;
            checkInput();
        }

        // æ£€æŸ¥è¾“å…¥
        function checkInput() {
            const input = document.getElementById('mood-input').value.trim();
            const btn = document.getElementById('submit-btn');
            btn.disabled = !input;
        }

        // æ˜¾ç¤ºæç¤º
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        // è°ƒç”¨ Gemini AI åˆ†ææƒ…ç»ª
        async function analyzeMood() {
            const input = document.getElementById('mood-input').value.trim();
            if (!input) return;

            const btn = document.getElementById('submit-btn');
            const originalContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div><span>Gemini åˆ†æä¸­...</span>';

            try {
                const prompt = `ä½ æ˜¯ä¸€ä½å¯Œæœ‰åŒç†å¿ƒçš„å¤©æ°”æ˜ å°„å¸ˆã€‚æ ¹æ®ç”¨æˆ·çš„æƒ…ç»ªçŠ¶æ€æè¿°ï¼Œé€‰æ‹©æœ€åŒ¹é…çš„å¤©æ°”ç°è±¡ã€‚

å¯é€‰å¤©æ°”åŠå¯¹åº”æƒ…ç»ªï¼š
- æ™´æœ—ï¼šå¼€å¿ƒã€æ»¡è¶³ã€å……æ»¡å¸Œæœ›ã€æ„‰æ‚¦
- å¤šäº‘ï¼šè½»å¾®å¿§è™‘ã€ä¸ç¡®å®šã€çŠ¹è±«
- é˜´å¤©ï¼šéƒé—·ã€ä½è½ã€æ— ç²¾æ‰“é‡‡ã€å‹æŠ‘
- é›¾ï¼šè¿·èŒ«ã€å›°æƒ‘ã€çœ‹ä¸æ¸…æ–¹å‘ã€ä¸ç¡®å®š
- å°é›¨ï¼šä¼¤æ„Ÿã€æ€å¿µã€æ¸©æŸ”çš„æƒ…ç»ªã€æ€€æ—§
- å¤§é›¨ï¼šæ‚²ä¼¤ã€ç—›è‹¦ã€æƒ…ç»ªå®£æ³„ã€å¤±è½
- é£ï¼šç„¦è™‘ã€çƒ¦èºã€åç«‹ä¸å®‰ã€ç´§å¼ 
- æ— é£ï¼šç©ºè™šã€éº»æœ¨ã€å¤±å»æ„ŸçŸ¥ã€ç–²æƒ«
- é»„æ˜ï¼šæ€€æ—§ã€æ„Ÿæ…¨ã€æ—¶å…‰æµé€ã€æ€å¿µ
- æ·±å¤œï¼šå­¤ç‹¬ã€æ²‰æ€ã€å†…çœã€å¯‚å¯
- é›·é›¨ï¼šæ„¤æ€’ã€çˆ†å‘ã€å¼ºçƒˆæƒ…ç»ªã€çƒ¦èº
- é›ªï¼šå®é™ã€çº¯å‡€ã€ä¸ä¸–éš”ç»çš„å¹³å’Œ

ç”¨æˆ·çŠ¶æ€æè¿°ï¼š"${input}"

è¯·åªè¿”å›å¤©æ°”åç§°ï¼ˆå¿…é¡»æ˜¯ä¸Šé¢åˆ—è¡¨ä¸­çš„æŸä¸€ä¸ªï¼Œå¦‚"å°é›¨"ï¼‰ï¼Œä¸è¦æœ‰ä»»ä½•è§£é‡Šï¼Œåªè¿”å›ä¸¤ä¸ªå­—æˆ–ä¸‰ä¸ªå­—çš„å¤©æ°”åç§°ã€‚`;

                const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.3,
                            maxOutputTokens: 10,
                            topP: 0.8,
                            topK: 10
                        }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'API è¯·æ±‚å¤±è´¥');
                }
                
                const data = await response.json();
                
                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                    throw new Error('API è¿”å›æ•°æ®å¼‚å¸¸');
                }
                
                const weatherName = data.candidates[0].content.parts[0].text.trim();
                console.log('Gemini åˆ†æç»“æœ:', weatherName);
                applyWeatherByName(weatherName, input);
                
            } catch (error) {
                console.error('Gemini API é”™è¯¯:', error);
                showToast('AI åˆ†æå¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°åˆ†æ...');
                // å¤±è´¥æ—¶å›é€€åˆ°æœ¬åœ°åˆ†æ
                await simulateLocalAnalysis(input);
            } finally {
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        }

        // æœ¬åœ°æ¨¡æ‹Ÿåˆ†æï¼ˆå¤‡é€‰æ–¹æ¡ˆï¼‰
        async function simulateLocalAnalysis(input) {
            await new Promise(resolve => setTimeout(resolve, 500));
            
            const lower = input.toLowerCase();
            let weather = 'lightCloud';
            
            // å…³é”®è¯åŒ¹é…
            for (const [key, config] of Object.entries(weatherConfig)) {
                if (config.keywords.some(k => lower.includes(k))) {
                    weather = key;
                    break;
                }
            }
            
            applyWeather(weather, input);
        }

        // æ ¹æ®å¤©æ°”åç§°åº”ç”¨å¤©æ°”
        function applyWeatherByName(weatherName, moodText) {
            // æå–å¤©æ°”åç§°ï¼ˆå»é™¤å¯èƒ½çš„å¼•å·ã€æ ‡ç‚¹ç­‰ï¼‰
            const cleanName = weatherName.replace(/["'ï¼Œã€‚ï¼ï¼Ÿ.!?]/g, '').trim();
            
            // æŸ¥æ‰¾åŒ¹é…çš„å¤©æ°”
            let matchedWeather = null;
            
            // é¦–å…ˆç²¾ç¡®åŒ¹é…
            for (const [key, config] of Object.entries(weatherConfig)) {
                if (config.name === cleanName || config.keywords.includes(cleanName)) {
                    matchedWeather = key;
                    break;
                }
            }
            
            // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå°è¯•æ¨¡ç³ŠåŒ¹é…
            if (!matchedWeather) {
                const nameMap = {
                    'æ™´æœ—': 'clear', 'æ™´å¤©': 'clear', 'é˜³å…‰': 'clear',
                    'å¤šäº‘': 'lightCloud', 'é˜´å¤©': 'overcast', 'é˜´': 'overcast',
                    'é›¾': 'fog', 'å¤§é›¾': 'fog', 'é›¾éœ¾': 'fog',
                    'å°é›¨': 'rain', 'é›¨': 'rain', 'ä¸‹é›¨': 'rain', 'é˜µé›¨': 'rain',
                    'å¤§é›¨': 'heavyRain', 'æš´é›¨': 'heavyRain',
                    'é£': 'wind', 'å¤§é£': 'wind', 'å¾®é£': 'wind',
                    'æ— é£': 'still', 'é™æ­¢': 'still',
                    'é»„æ˜': 'dusk', 'å‚æ™š': 'dusk', 'æ—¥è½': 'dusk',
                    'æ·±å¤œ': 'night', 'å¤œ': 'night', 'é»‘å¤œ': 'night', 'å¤œæ™š': 'night',
                    'é›·é›¨': 'thunder', 'é›·': 'thunder', 'é—ªç”µ': 'thunder',
                    'é›ª': 'snow', 'ä¸‹é›ª': 'snow', 'å¤§é›ª': 'snow'
                };
                
                matchedWeather = nameMap[cleanName] || 'lightCloud';
            }
            
            applyWeather(matchedWeather, moodText);
        }

        // åº”ç”¨å¤©æ°”æ•ˆæœ
        function applyWeather(weather, moodText) {
            const config = weatherConfig[weather];
            if (!config) {
                console.error('æœªçŸ¥å¤©æ°”:', weather);
                return;
            }
            
            currentWeather = weather;
            
            // æ›´æ–°èƒŒæ™¯
            const app = document.getElementById('app');
            Object.values(weatherConfig).forEach(w => app.classList.remove(w.bg));
            app.classList.add(config.bg);
            
            // æ›´æ–°å°çƒ
            const orb = document.getElementById('orb');
            const orbGlow = document.getElementById('orb-glow');
            Object.values(weatherConfig).forEach(w => orb.classList.remove(w.orb));
            orb.classList.add(config.orb);
            
            // æ›´æ–°å›¾æ ‡å’Œæ–‡å­—
            document.getElementById('weather-icon').textContent = config.icon;
            document.getElementById('weather-text').textContent = `å†…å¿ƒå¤©æ°”ï¼š${config.name}`;
            document.getElementById('mood-text').textContent = moodText ? `ã€Œ${moodText}ã€` : '';
            
            // æ›´æ–°å‘å…‰é¢œè‰²
            const glowColors = {
                clear: 'rgba(255, 215, 0, 0.4)',
                lightCloud: 'rgba(192, 192, 192, 0.4)',
                overcast: 'rgba(128, 128, 128, 0.4)',
                fog: 'rgba(224, 224, 224, 0.4)',
                rain: 'rgba(74, 144, 217, 0.4)',
                heavyRain: 'rgba(44, 62, 80, 0.4)',
                wind: 'rgba(127, 140, 141, 0.4)',
                still: 'rgba(52, 73, 94, 0.4)',
                dusk: 'rgba(231, 76, 60, 0.4)',
                night: 'rgba(142, 68, 173, 0.4)',
                thunder: 'rgba(155, 89, 182, 0.4)',
                snow: 'rgba(236, 240, 241, 0.4)'
            };
            orbGlow.style.background = glowColors[weather] || glowColors.clear;
            
            // æ›´æ–°ç‰¹æ•ˆ
            updateWeatherEffects(weather);
            
            // å…³é—­å¼¹çª—å¹¶æç¤º
            closeModal();
            showToast(`å·²åˆ‡æ¢è‡³${config.name}å¤©æ°”`);
        }

        // åˆå§‹åŒ–å¤©æ°”ç‰¹æ•ˆ Canvas
        function initWeatherEffects() {
            const canvas = document.getElementById('weather-effects');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            window.addEventListener('resize', () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            });
        }

        // æ›´æ–°å¤©æ°”ç‰¹æ•ˆ
        function updateWeatherEffects(weather) {
            const canvas = document.getElementById('weather-effects');
            const ctx = canvas.getContext('2d');
            
            // æ¸…é™¤ä¹‹å‰çš„åŠ¨ç”»
            if (weatherEffectId) {
                cancelAnimationFrame(weatherEffectId);
            }
            
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // æ ¹æ®å¤©æ°”å¯åŠ¨ç‰¹æ•ˆ
            switch(weather) {
                case 'rain':
                case 'heavyRain':
                    startRainEffect(ctx, canvas, weather === 'heavyRain' ? 2 : 1);
                    break;
                case 'snow':
                    startSnowEffect(ctx, canvas);
                    break;
                case 'wind':
                    startWindEffect(ctx, canvas);
                    break;
                case 'thunder':
                    startThunderEffect(ctx, canvas);
                    break;
                case 'fog':
                    startFogEffect(ctx, canvas);
                    break;
            }
        }

        // é›¨ç‰¹æ•ˆ
        function startRainEffect(ctx, canvas, intensity) {
            const drops = [];
            const count = 100 * intensity;
            
            for (let i = 0; i < count; i++) {
                drops.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    speed: 5 + Math.random() * 10,
                    length: 10 + Math.random() * 20
                });
            }
            
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.lineWidth = 1;
                
                drops.forEach(drop => {
                    ctx.beginPath();
                    ctx.moveTo(drop.x, drop.y);
                    ctx.lineTo(drop.x - 2, drop.y + drop.length);
                    ctx.stroke();
                    
                    drop.y += drop.speed;
                    drop.x -= 1;
                    
                    if (drop.y > canvas.height) {
                        drop.y = -drop.length;
                        drop.x = Math.random() * canvas.width;
                    }
                });
                
                weatherEffectId = requestAnimationFrame(animate);
            }
            animate();
        }

        // é›ªç‰¹æ•ˆ
        function startSnowEffect(ctx, canvas) {
            const flakes = [];
            for (let i = 0; i < 50; i++) {
                flakes.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    radius: 1 + Math.random() * 3,
                    speed: 0.5 + Math.random() * 1.5,
                    drift: (Math.random() - 0.5) * 0.5
                });
            }
            
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                flakes.forEach(flake => {
                    ctx.beginPath();
                    ctx.arc(flake.x, flake.y, flake.radius, 0, Math.PI * 2);
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                    ctx.fill();
                    
                    flake.y += flake.speed;
                    flake.x += flake.drift;
                    
                    if (flake.y > canvas.height) {
                        flake.y = -5;
                        flake.x = Math.random() * canvas.width;
                    }
                    if (flake.x > canvas.width) flake.x = 0;
                    if (flake.x < 0) flake.x = canvas.width;
                });
                
                weatherEffectId = requestAnimationFrame(animate);
            }
            animate();
        }

        // é£ç‰¹æ•ˆ
        function startWindEffect(ctx, canvas) {
            const lines = [];
            for (let i = 0; i < 5; i++) {
                lines.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    width: 100 + Math.random() * 200,
                    speed: 3 + Math.random() * 2
                });
            }
            
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.15)';
                ctx.lineWidth = 2;
                
                lines.forEach(line => {
                    ctx.beginPath();
                    ctx.moveTo(line.x, line.y);
                    ctx.lineTo(line.x + line.width, line.y);
                    ctx.stroke();
                    
                    line.x += line.speed;
                    
                    if (line.x > canvas.width) {
                        line.x = -line.width;
                        line.y = Math.random() * canvas.height;
                    }
                });
                
                weatherEffectId = requestAnimationFrame(animate);
            }
            animate();
        }

        // é›·ç”µç‰¹æ•ˆ
        function startThunderEffect(ctx, canvas) {
            let lastFlash = 0;
            
            function animate(timestamp) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // éšæœºé—ªç”µ
                if (timestamp - lastFlash > 3000 + Math.random() * 4000) {
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    lastFlash = timestamp;
                    
                    setTimeout(() => {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                    }, 100);
                }
                
                weatherEffectId = requestAnimationFrame(animate);
            }
            animate();
        }

        // é›¾ç‰¹æ•ˆ
        function startFogEffect(ctx, canvas) {
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                const gradient = ctx.createRadialGradient(
                    canvas.width / 2, canvas.height / 2, 50,
                    canvas.width / 2, canvas.height / 2, 300
                );
                gradient.addColorStop(0, 'rgba(255, 255, 255, 0.4)');
                gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
                
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                weatherEffectId = requestAnimationFrame(animate);
            }
            animate();
        }

        // ESC é”®å…³é—­å¼¹çª—
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });
    </script>
</body>
</html>
